# 留言板系统数据库设计文档

## 1. 文档说明

### 1.1 设计目标

适配留言板核心业务：用户发表 / 编辑 / 删除主留言、查看留言列表、回复主留言（仅创建 / 删除，支持多级回复）、主留言点赞、主留言举报、管理员审核举报，简化冗余字段，保证数据结构简洁且满足业务需求。

### 1.2 数据库类型

MySQL（InnoDB 引擎，支持外键和事务，保证数据一致性）

### 1.3 命名规范

* 表名采用蛇形命名法（snake_case）
* 字段名采用蛇形命名法（snake_case）
* 主键统一命名为 id
* 外键字段命名为关联表名加 _id 后缀，如 user_id
* 时间字段统一添加 _time 后缀，如 create_time
* 布尔类型字段添加 is_ 或 has_ 前缀，如 is_deleted
* 统计类字段添加 _count 后缀，如 like_count

数据库名称：ssm_message

## 2. 数据表设计

### 2.1 用户表（user）

存储用户基础信息，区分普通用户 / 管理员，管控用户状态。



| 字段名          | 类型              | 约束    | 默认值 | 注释                     |
| ------------ | --------------- | ----- | --- | ---------------------- |
| id           | BIGINT UNSIGNED | 主键、自增 | -   | 用户唯一 ID                |
| email        | VARCHAR(64)     | 非空、唯一 | -   | 用户邮箱（登录账号）             |
| nickname     | VARCHAR(32)     | 非空    | -   | 用户昵称                   |
| password     | VARCHAR(64)     | 非空    | -   | 密码（建议 MD5/BCrypt 加密存储） |
| role         | TINYINT         | 非空    | 0   | 角色：0 - 普通用户 1 - 管理员    |
| status       | TINYINT         | 非空    | 0   | 状态：-1 - 停用 0 - 正常      |
| create_time | BIGINT          | 非空    | -   | 创建时间戳（毫秒）              |
| is_deleted  | TINYINT         | 非空    | 0   | 是否删除：0 - 否 1 - 是       |

**索引**：



* 主键索引：id

* 唯一索引：uk_email（email）

* 普通索引：idx_role_status（role, status）

**外键**：无

### 2.2 主留言表（message）

存储用户发布的主留言信息，支持编辑、点赞、举报、搜索、排序。



| 字段名          | 类型              | 约束    | 默认值 | 注释                              |
| ------------ | --------------- | ----- | --- | ------------------------------- |
| id           | BIGINT UNSIGNED | 主键、自增 | -   | 留言唯一 ID                         |
| title        | VARCHAR(128)    | 非空    | -   | 留言标题                            |
| content      | TEXT            | 非空    | -   | 留言内容（支持富文本）                     |
| like_count  | INT             | 非空    | 0   | 获赞数                             |
| creator_id  | BIGINT UNSIGNED | 非空    | -   | 创建者 ID（关联 user.id）              |
| create_time | BIGINT          | 非空    | -   | 创建时间戳（毫秒）                       |
| update_time | BIGINT          | 非空    | -   | 更新时间戳（毫秒）                       |
| status       | TINYINT         | 非空    | 0   | 状态：-2 - 违规 -1 - 待审核 / 停用 0 - 正常 |
| is_deleted  | TINYINT         | 非空    | 0   | 是否删除：0 - 否 1 - 是                |

**索引**：



* 主键索引：id

* 普通索引：idx_creator_id（creator_id）

* 普通索引：idx_status_create_time（status, create_time）

* 普通索引：idx_title_content（title, content (100)）

**外键**：



* fk_message_creator：creator_id → user.id（级联删除）

### 2.3 回复表（reply）

存储对主留言的回复，支持多级回复，仅允许创建 / 逻辑删除，无更新操作。



| 字段名          | 类型              | 约束    | 默认值  | 注释                                |
| ------------ | --------------- | ----- | ---- | --------------------------------- |
| id           | BIGINT UNSIGNED | 主键、自增 | -    | 回复唯一 ID                           |
| message_id  | BIGINT UNSIGNED | 非空    | -    | 所属主留言 ID（关联 message.id）           |
| creator_id  | BIGINT UNSIGNED | 非空    | -    | 回复者 ID（关联 user.id）                |
| parent_id   | BIGINT UNSIGNED | 可为空   | NULL | 回复父 ID：NULL - 回复主留言 非 NULL - 多级回复 |
| content      | TEXT            | 非空    | -    | 回复内容                              |
| create_time | BIGINT          | 非空    | -    | 创建时间戳（毫秒）                         |
| is_deleted  | TINYINT         | 非空    | 0    | 是否删除：0 - 否 1 - 是                  |

**索引**：



* 主键索引：id

* 普通索引：idx_message_id（message_id）

* 普通索引：idx_parent_id（parent_id）

**外键**：



* fk_reply_message：message_id → message.id（级联删除）

* fk_reply_creator：creator_id → user.id（级联删除）

* fk_reply_parent：parent_id → reply.id（级联删除）

### 2.4 点赞记录表（like_record）

存储用户对主留言的点赞行为，防止重复点赞，支持取消点赞。



| 字段名          | 类型              | 约束    | 默认值 | 注释                       |
| ------------ | --------------- | ----- | --- | ------------------------ |
| id           | BIGINT UNSIGNED | 主键、自增 | -   | 点赞记录 ID                  |
| user_id     | BIGINT UNSIGNED | 非空    | -   | 点赞用户 ID（关联 user.id）      |
| message_id  | BIGINT UNSIGNED | 非空    | -   | 点赞的主留言 ID（关联 message.id） |
| create_time | BIGINT          | 非空    | -   | 点赞时间戳（毫秒）                |
| is_canceled | TINYINT         | 非空    | 0   | 取消状态：0 - 未取消 1 - 已取消     |

**索引**：



* 主键索引：id

* 唯一索引：uk_user_message（user_id, message_id）

* 普通索引：idx_user_id（user_id）

* 普通索引：idx_message_id（message_id）

**外键**：



* fk_like_user：user_id → user.id（级联删除）

* fk_like_message：message_id → message.id（级联删除）

**普通索引**：

* idx_user_id（user_id）

### 2.5 举报记录表（report）

存储用户对主留言的举报信息，支持管理员审核流程。



| 字段名             | 类型              | 约束    | 默认值  | 注释                             |
| --------------- | --------------- | ----- | ---- | ------------------------------ |
| id              | BIGINT UNSIGNED | 主键、自增 | -    | 举报记录 ID                        |
| user_id        | BIGINT UNSIGNED | 非空    | -    | 举报用户 ID（关联 user.id）            |
| message_id     | BIGINT UNSIGNED | 非空    | -    | 举报的主留言 ID（关联 message.id）       |
| reason          | VARCHAR(256)    | 非空    | -    | 举报原因                           |
| create_time    | BIGINT          | 非空    | -    | 举报时间戳（毫秒）                      |
| audit_status   | TINYINT         | 非空    | 0    | 审核状态：0 - 待审核 1 - 审核通过 2 - 审核驳回 |
| audit_user_id | BIGINT UNSIGNED | 可为空   | NULL | 审核管理员 ID（关联 user.id）           |
| audit_time     | BIGINT          | 可为空   | NULL | 审核时间戳（毫秒）                      |

**索引**：



* 主键索引：id

* 普通索引：idx_audit_status（audit_status）

* 普通索引：idx_message_id（message_id）

**外键**：



* fk_report_user：user_id → user.id（级联删除）

* fk_report_message：message_id → message.id（级联删除）

* fk_report_audit_user：audit_user_id → user.id（删除时设为 NULL）

## 3. 核心业务逻辑适配

### 3.1 留言热度排序

通过 `message` 表的 `like_count`（获赞数）降序 + `create_time`（创建时间）降序实现，替代冗余的热度分字段。

### 3.2 回复数统计

查询主留言的回复数时，执行：



```
SELECT COUNT(id) FROM reply WHERE message_id = ? AND is_deleted = 0;
```

### 3.3 点赞数同步

用户点赞 / 取消点赞时，同步更新 `message` 表的 `like_count` 字段：



* 点赞：`UPDATE message SET like_count = like_count + 1 WHERE id = ?;`

* 取消点赞：`UPDATE message SET like_count = like_count - 1 WHERE id = ? AND like_count > 0;`

### 3.4 举报审核流程



1. 用户举报：插入 `report` 表，`audit_status` 默认为 0（待审核）；

2. 管理员审核：更新 `audit_status`（1 - 通过 / 2 - 驳回）、`audit_user_id`、`audit_time`；

3. 审核通过：更新 `message` 表的 `status` 为 -2（违规），前端隐藏该留言；

4. 审核驳回：`message` 表状态保持不变。

### 3.5 回复操作限制



* 创建：插入 `reply` 表，仅填写必填字段；

* 删除：更新 `is_deleted = 1`（逻辑删除），无 `UPDATE` 语句修改 `content` 等核心字段。